name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true
        type: string

# NOTE: This workflow uses npm Trusted Publishing with OIDC (OpenID Connect)
# No NPM_TOKEN secret is required - authentication is handled via GitHub's OIDC tokens
#
# Prerequisites:
# 1. npm CLI >= 11.5.1 (included with Node.js 24+)
# 2. Each package must be configured with Trusted Publisher on npmjs.com
#    Add Trusted Publisher with these settings:
#      * Provider: GitHub Actions
#      * Organization/User: greydragon888
#      * Repository: real-router
#      * Workflow: release.yml
#      * Environment: (leave empty)
#
# Documentation: https://docs.npmjs.com/trusted-publishers/
#
# NOTE: pnpm does not support OIDC Trusted Publishing (see https://github.com/pnpm/pnpm/issues/9812)
# We use pnpm for install/build but npm for publish.

permissions:
  contents: write
  packages: write
  id-token: write # Required for OIDC Trusted Publishing

# Turbo Remote Cache
env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  release:
    name: Release to NPM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # version is read from package.json packageManager field

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
          # NOTE: Do NOT use registry-url here!
          # It creates .npmrc with ${NODE_AUTH_TOKEN} which conflicts with OIDC Trusted Publishing.
          # npm CLI v11.5.1+ automatically detects OIDC and uses it for authentication.

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm run build

      - name: Run tests
        run: pnpm run test

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update package versions
        run: |
          for dir in packages/*/; do
            if [ -f "$dir/package.json" ]; then
              echo "Updating version in $dir"
              cd "$dir"
              npm version "${{ steps.version.outputs.VERSION }}" --no-git-tag-version --allow-same-version
              cd ../..
            fi
          done

      # NOTE: workspace:^ conversion is handled by pnpm publish automatically

      - name: Verify packages
        run: |
          for dir in packages/*/; do
            if [ -f "$dir/package.json" ]; then
              name=$(node -p "require('./${dir}package.json').name")
              echo "=== $name ==="
              cd "$dir"
              npm pack --dry-run
              cd ../..
              echo ""
            fi
          done

      - name: Debug OIDC environment
        run: |
          echo "=== GitHub Context ==="
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo ""
          echo "=== OIDC Environment Variables ==="
          echo "ACTIONS_ID_TOKEN_REQUEST_URL: ${ACTIONS_ID_TOKEN_REQUEST_URL:-NOT SET}"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+SET (${#ACTIONS_ID_TOKEN_REQUEST_TOKEN} chars)}"
          echo ""
          echo "=== npm Configuration ==="
          echo "npm version: $(npm --version)"
          echo "node version: $(node --version)"

      # Publish order matters due to dependencies:
      # 1. @real-router/logger (no @real-router deps)
      # 2. @real-router/types (depends on logger)
      # 3. All other packages (depend on types/logger/core)

      - name: Publish @real-router/logger first
        run: |
          cd packages/logger
          name=$(node -p "require('./package.json').name")
          version=$(node -p "require('./package.json').version")

          if npm view "${name}@${version}" version >/dev/null 2>&1; then
            echo "‚è≠Ô∏è Skipping $name@${version} (already published)"
          else
            echo "üì¶ Publishing $name@${version} (1/3 - base package)..."
            pnpm publish --provenance --access public --no-git-checks
          fi
          cd ../..

      - name: Publish @real-router/types second
        run: |
          cd packages/core-types
          name=$(node -p "require('./package.json').name")
          version=$(node -p "require('./package.json').version")

          if npm view "${name}@${version}" version >/dev/null 2>&1; then
            echo "‚è≠Ô∏è Skipping $name@${version} (already published)"
          else
            echo "üì¶ Publishing $name@${version} (2/3 - types package)..."
            pnpm publish --provenance --access public --no-git-checks
          fi
          cd ../..

      - name: Publish remaining packages to NPM
        run: |
          for dir in packages/*/; do
            if [ -f "$dir/package.json" ]; then
              name=$(node -p "require('./${dir}package.json').name")
              version=$(node -p "require('./${dir}package.json').version")
              private=$(node -p "require('./${dir}package.json').private || false")

              # Skip already published packages (logger, types) and private packages
              if [ "$name" = "@real-router/logger" ] || [ "$name" = "@real-router/types" ]; then
                echo "‚è≠Ô∏è Skipping $name (published in previous steps)"
              elif [ "$private" = "true" ]; then
                echo "‚è≠Ô∏è Skipping $name (private package)"
              elif npm view "${name}@${version}" version >/dev/null 2>&1; then
                echo "‚è≠Ô∏è Skipping $name@${version} (already published)"
              else
                echo "üì¶ Publishing $name@${version} (3/3)..."
                cd "$dir"
                pnpm publish --provenance --access public --no-git-checks
                cd ../..
              fi
            fi
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ env.VERSION }}
          tag_name: v${{ env.VERSION }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(env.VERSION, '-') }}
