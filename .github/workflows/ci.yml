name: CI

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Turbo Remote Cache - shared across all jobs
env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  # Fast check to determine if CI should run
  # Always runs to satisfy required status checks
  check:
    name: Check Changes
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.changes.outputs.should_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for code changes
        id: changes
        run: |
          # Skip for release PRs (code already validated by source PR)
          if [[ "${{ github.head_ref }}" == changeset-release/* ]]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "ðŸš€ Release PR detected, skipping CI"
            exit 0
          fi

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
          else
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
          fi

          # Get changed files, excluding docs and CI configs
          CODE_CHANGES=$(git diff --name-only "$BASE" "$HEAD" | grep -vE '^(\.github/|.*\.md$)' | head -1)

          if [ -z "$CODE_CHANGES" ]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ Only docs/CI changes detected, skipping CI"
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "ðŸ” Code changes detected, running full CI"
          fi

  prepare:
    name: Prepare (Cache Warm-up)
    runs-on: ubuntu-latest
    needs: [check]
    # Always run to report status, but skip heavy steps if not needed
    if: always()
    steps:
      - name: Skip notification
        if: needs.check.outputs.should_run != 'true'
        run: echo "âœ… Skipping CI - no code changes or release PR"

      - name: Checkout
        if: needs.check.outputs.should_run == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch master for Turbo comparison
        if: needs.check.outputs.should_run == 'true' && github.event_name == 'pull_request'
        run: git fetch origin master:master

      - name: Install pnpm
        if: needs.check.outputs.should_run == 'true'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        if: needs.check.outputs.should_run == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        if: needs.check.outputs.should_run == 'true'
        run: pnpm install --frozen-lockfile

      - name: Lint & Type Check
        if: needs.check.outputs.should_run == 'true'
        run: pnpm turbo run lint type-check ${{ github.event_name == 'pull_request' && '--affected' || '' }}

      - name: Test with Coverage
        if: needs.check.outputs.should_run == 'true'
        run: pnpm turbo run test ${{ github.event_name == 'pull_request' && '--affected' || '' }} -- --coverage

      - name: Build
        if: needs.check.outputs.should_run == 'true'
        run: pnpm turbo run build ${{ github.event_name == 'pull_request' && '--affected' || '' }}

      - name: Check dependency consistency
        if: needs.check.outputs.should_run == 'true'
        run: pnpm lint:deps

      - name: Check for duplicate dependencies
        if: needs.check.outputs.should_run == 'true'
        run: pnpm lint:dedupe

      - name: Upload coverage artifacts
        if: needs.check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: coverage-reports
          path: packages/*/coverage/
          retention-days: 1

      - name: Upload build artifacts
        if: needs.check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: packages/*/dist/
          retention-days: 1

  coverage:
    name: Coverage (Codecov)
    needs: [check, prepare]
    if: needs.check.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - name: Download coverage artifacts
        uses: actions/download-artifact@v7
        with:
          name: coverage-reports
          path: packages

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: >-
            packages/core/coverage/lcov.info,
            packages/react/coverage/lcov.info,
            packages/browser-plugin/coverage/lcov.info,
            packages/logger-plugin/coverage/lcov.info,
            packages/logger/coverage/lcov.info,
            packages/persistent-params-plugin/coverage/lcov.info,
            packages/helpers/coverage/lcov.info,
            packages/type-guards/coverage/lcov.info,
            packages/route-tree/coverage/lcov.info,
            packages/search-params/coverage/lcov.info
          fail_ci_if_error: true

  sonarcloud:
    name: SonarCloud
    needs: [check, prepare]
    if: needs.check.outputs.should_run == 'true' && github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download coverage artifacts
        uses: actions/download-artifact@v7
        with:
          name: coverage-reports
          path: packages

      - name: Cache SonarCloud packages
        uses: actions/cache@v5
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar

      - name: Get version from core package
        id: version
        run: |
          VERSION=$(node -p 'require("./packages/core/package.json").version')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7
        with:
          args: >
            -Dsonar.projectVersion=${{ steps.version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io

  bundle-size:
    name: Bundle Size
    needs: [check, prepare]
    if: needs.check.outputs.should_run == 'true' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout PR
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build PR branch (cache hit expected)
        run: pnpm turbo run build --affected

      - name: Get PR sizes
        id: pr_sizes
        run: |
          echo "sizes<<EOF" >> $GITHUB_OUTPUT
          npx size-limit --json 2>/dev/null >> $GITHUB_OUTPUT || echo "[]" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Checkout base branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.base_ref }}
          clean: false

      - name: Install base dependencies
        run: pnpm install --frozen-lockfile

      - name: Build base branch
        run: pnpm build

      - name: Get base sizes
        id: base_sizes
        run: |
          echo "sizes<<EOF" >> $GITHUB_OUTPUT
          npx size-limit --json 2>/dev/null >> $GITHUB_OUTPUT || echo "[]" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Compare and comment
        uses: actions/github-script@v8
        with:
          script: |
            const prSizes = JSON.parse(`${{ steps.pr_sizes.outputs.sizes }}` || '[]');
            const baseSizes = JSON.parse(`${{ steps.base_sizes.outputs.sizes }}` || '[]');

            const formatBytes = (bytes) => {
              if (bytes == null || isNaN(bytes)) return 'â€”';
              if (bytes === 0) return '0 B';
              const sign = bytes < 0 ? '-' : '';
              const abs = Math.abs(bytes);
              const k = 1024;
              const sizes = ['B', 'KB', 'MB'];
              const i = Math.floor(Math.log(abs) / Math.log(k));
              return sign + parseFloat((abs / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };

            const formatDiff = (pr, base) => {
              if (pr == null || isNaN(pr)) return 'â€”';
              if (!base || isNaN(base)) return 'new';
              const diff = pr - base;
              const percent = base > 0 ? ((diff / base) * 100).toFixed(1) : 0;
              if (diff === 0) return '0';
              const sign = diff > 0 ? '+' : '';
              return `${sign}${formatBytes(diff)} (${sign}${percent}%)`;
            };

            const baseMap = new Map();
            for (const item of baseSizes) {
              baseMap.set(item.name, item.size);
            }

            let rows = [];
            let totalPr = 0;
            let totalBase = 0;
            let hasChanges = false;

            for (const item of prSizes) {
              const prSize = item.size ?? 0;
              const baseSize = baseMap.get(item.name) ?? 0;
              totalPr += isNaN(prSize) ? 0 : prSize;
              totalBase += isNaN(baseSize) ? 0 : baseSize;

              const diff = (isNaN(prSize) ? 0 : prSize) - (isNaN(baseSize) ? 0 : baseSize);
              if (diff !== 0) hasChanges = true;

              const status = item.passed === false ? 'âŒ' : 'âœ…';
              rows.push(`| ${status} ${item.name} | ${formatBytes(item.size)} | ${formatBytes(baseMap.get(item.name))} | ${formatDiff(item.size, baseMap.get(item.name))} |`);
            }

            let body = `## Bundle Size Report\n\n`;

            if (prSizes.length === 0) {
              body += `Could not measure bundle sizes.\n`;
            } else {
              body += `| Status | Package | PR Size | Base Size | Diff |\n`;
              body += `|--------|---------|---------|-----------|------|\n`;
              body += rows.join('\n');
              body += `\n\n`;

              const totalDiff = totalPr - totalBase;
              const totalPercent = totalBase > 0 ? ((totalDiff / totalBase) * 100).toFixed(1) : 0;
              const totalSign = totalDiff > 0 ? '+' : '';

              body += `**Total:** ${formatBytes(totalPr)} (${totalSign}${formatBytes(totalDiff)}, ${totalSign}${totalPercent}%)\n\n`;

              if (!hasChanges) {
                body += `No size changes detected.\n`;
              }

              const failures = prSizes.filter(s => s.passed === false);
              if (failures.length > 0) {
                body += `\n**Size limit exceeded for:** ${failures.map(f => f.name).join(', ')}\n`;
              }
            }

            body += `\n<details><summary>Size limits configured in <code>.size-limit.json</code></summary>\n\n`;
            body += `Run \`pnpm size\` locally to check bundle sizes.\n</details>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('Bundle Size Report'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

            core.summary.addRaw(body).write();
