name: Changeset Check

on:
  pull_request:
    branches: [master]

jobs:
  require-changeset:
    name: Require Changeset
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for source changes requiring changeset
        id: check
        run: |
          # Get files changed in PR
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Public packages that require changesets
          PUBLIC_PACKAGES="core|core-types|react|browser-plugin|logger|logger-plugin|helpers|persistent-params-plugin"

          # Check if any source files in public packages changed
          SOURCE_CHANGED=$(echo "$CHANGED" | grep -E "^packages/($PUBLIC_PACKAGES)/src/" || true)

          if [ -z "$SOURCE_CHANGED" ]; then
            echo "No source files changed in public packages"
            echo "needs_changeset=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Source files changed:"
          echo "$SOURCE_CHANGED"
          echo "needs_changeset=true" >> $GITHUB_OUTPUT

          # Check for changeset files
          CHANGESETS=$(echo "$CHANGED" | grep -E '^\.changeset/.*\.md$' | grep -v README.md || true)

          if [ -z "$CHANGESETS" ]; then
            echo "has_changeset=false" >> $GITHUB_OUTPUT
          else
            echo "Changesets found:"
            echo "$CHANGESETS"
            echo "has_changeset=true" >> $GITHUB_OUTPUT
          fi

      - name: Fail if changeset missing
        if: steps.check.outputs.needs_changeset == 'true' && steps.check.outputs.has_changeset == 'false'
        run: |
          echo "::error::Source files changed but no changeset found!"
          echo ""
          echo "Public package source files were modified. A changeset is required."
          echo ""
          echo "To add a changeset, run:"
          echo "  pnpm changeset"
          echo ""
          echo "Or create a file manually in .changeset/ directory."
          echo "See .changeset/README.md for detailed guidelines and examples."
          echo ""
          echo "If this change doesn't need a release, add #trivial to PR title."
          exit 1

  check-pr-reference:
    name: Check PR Reference
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check changesets for PR references
        id: check
        run: |
          # Get changeset files added/modified in this PR
          CHANGESETS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '.changeset/*.md' | grep -v README.md || true)

          if [ -z "$CHANGESETS" ]; then
            echo "No changeset files in this PR"
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changesets=true" >> $GITHUB_OUTPUT
          echo "Found changesets: $CHANGESETS"

          # Check each changeset for #XX reference
          MISSING_REFS=""
          for file in $CHANGESETS; do
            if [ -f "$file" ]; then
              if ! grep -q '#[0-9]\+' "$file"; then
                MISSING_REFS="$MISSING_REFS $file"
              fi
            fi
          done

          if [ -n "$MISSING_REFS" ]; then
            echo "missing_refs=true" >> $GITHUB_OUTPUT
            echo "files=$MISSING_REFS" >> $GITHUB_OUTPUT
            echo "⚠️ Changesets without PR reference:$MISSING_REFS"
          else
            echo "missing_refs=false" >> $GITHUB_OUTPUT
            echo "✅ All changesets have PR references"
          fi

      - name: Comment on PR
        if: steps.check.outputs.missing_refs == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const files = `${{ steps.check.outputs.files }}`.trim().split(/\s+/);
            const prNumber = context.issue.number;
            const fileList = files.map(f => `- \`${f}\``).join('\n');

            const body = [
              '## ⚠️ Changeset Missing PR Reference',
              '',
              "The following changeset file(s) don't contain a PR/issue reference (`#XX`):",
              '',
              fileList,
              '',
              '**Why this matters:** PR references in changesets are used to link releases to their source tasks. This improves traceability in git history and release notes.',
              '',
              `**How to fix:** Edit the changeset description to include \`#${prNumber}\`:`,
              '',
              '```markdown',
              '---',
              '"@real-router/core": patch',
              '---',
              '',
              `fix: description of the change (#${prNumber})`,
              '```',
              '',
              'This is a **warning only** — the PR can still be merged.',
            ].join('\n');

            // Check for existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const marker = 'Changeset Missing PR Reference';
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }
