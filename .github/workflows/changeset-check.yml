name: Changeset Check

on:
  pull_request:
    branches: [master]

jobs:
  require-changeset:
    name: Require Changeset
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for source changes requiring changeset
        id: check
        run: |
          # Get files changed in PR
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Public packages that require changesets
          PUBLIC_PACKAGES="core|core-types|react|browser-plugin|logger|logger-plugin|helpers|persistent-params-plugin"

          # Check if any source files in public packages changed
          SOURCE_CHANGED=$(echo "$CHANGED" | grep -E "^packages/($PUBLIC_PACKAGES)/src/" || true)

          if [ -z "$SOURCE_CHANGED" ]; then
            echo "No source files changed in public packages"
            echo "needs_changeset=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Source files changed:"
          echo "$SOURCE_CHANGED"
          echo "needs_changeset=true" >> $GITHUB_OUTPUT

          # Check for changeset files
          CHANGESETS=$(echo "$CHANGED" | grep -E '^\.changeset/.*\.md$' | grep -v README.md || true)

          if [ -z "$CHANGESETS" ]; then
            echo "has_changeset=false" >> $GITHUB_OUTPUT
          else
            echo "Changesets found:"
            echo "$CHANGESETS"
            echo "has_changeset=true" >> $GITHUB_OUTPUT
          fi

      - name: Fail if changeset missing
        if: steps.check.outputs.needs_changeset == 'true' && steps.check.outputs.has_changeset == 'false'
        run: |
          echo "::error::Source files changed but no changeset found!"
          echo ""
          echo "Public package source files were modified. A changeset is required."
          echo ""
          echo "To add a changeset, run:"
          echo "  pnpm changeset"
          echo ""
          echo "Or create a file manually in .changeset/ directory."
          echo "See .changeset/README.md for detailed guidelines and examples."
          echo ""
          echo "If this change doesn't need a release, add #trivial to PR title."
          exit 1

  validate-changesets:
    name: Validate Changesets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate changesets
        id: validate
        run: |
          # Get changeset files added/modified in this PR
          CHANGESETS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '.changeset/*.md' | grep -v README.md || true)

          if [ -z "$CHANGESETS" ]; then
            echo "No changeset files in this PR"
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changesets=true" >> $GITHUB_OUTPUT
          echo "Found changesets: $CHANGESETS"

          HAS_ISSUES=false

          # --- Check 1: Missing PR/issue references (#XX) ---
          MISSING_REFS=""
          for file in $CHANGESETS; do
            if [ -f "$file" ]; then
              if ! grep -q '#[0-9]\+' "$file"; then
                MISSING_REFS="$MISSING_REFS $file"
              fi
            fi
          done

          if [ -n "$MISSING_REFS" ]; then
            echo "missing_refs=true" >> $GITHUB_OUTPUT
            echo "files_missing_refs=$MISSING_REFS" >> $GITHUB_OUTPUT
            echo "::error::Changesets without PR reference:$MISSING_REFS"
            HAS_ISSUES=true
          else
            echo "missing_refs=false" >> $GITHUB_OUTPUT
            echo "✅ All changesets have PR references"
          fi

          # --- Check 2: Multi-package changesets ---
          MULTI_PKG=""
          for file in $CHANGESETS; do
            if [ -f "$file" ]; then
              # Count lines with quoted package names in frontmatter (between --- markers)
              PKG_COUNT=$(sed -n '/^---$/,/^---$/p' "$file" | grep -c '"' || true)
              if [ "$PKG_COUNT" -gt 1 ]; then
                MULTI_PKG="$MULTI_PKG $file"
              fi
            fi
          done

          if [ -n "$MULTI_PKG" ]; then
            echo "multi_pkg=true" >> $GITHUB_OUTPUT
            echo "files_multi_pkg=$MULTI_PKG" >> $GITHUB_OUTPUT
            echo "::error::Multi-package changesets found:$MULTI_PKG"
            HAS_ISSUES=true
          else
            echo "multi_pkg=false" >> $GITHUB_OUTPUT
            echo "✅ All changesets are single-package"
          fi

          # --- Check 3: Private packages in changesets ---
          PRIVATE_PKGS="path-matcher|route-tree|router-benchmarks|search-params|type-guards"
          PRIVATE_IN_CS=""
          for file in $CHANGESETS; do
            if [ -f "$file" ]; then
              if grep -qE "\"($PRIVATE_PKGS)\"" "$file"; then
                PRIVATE_IN_CS="$PRIVATE_IN_CS $file"
              fi
            fi
          done

          if [ -n "$PRIVATE_IN_CS" ]; then
            echo "private_pkgs=true" >> $GITHUB_OUTPUT
            echo "files_private_pkgs=$PRIVATE_IN_CS" >> $GITHUB_OUTPUT
            echo "::error::Private packages in changesets:$PRIVATE_IN_CS"
            HAS_ISSUES=true
          else
            echo "private_pkgs=false" >> $GITHUB_OUTPUT
            echo "✅ No private packages in changesets"
          fi

          # --- Check 4: No major version bumps (pre-1.0) ---
          # TODO: Remove this check after 1.0 stable release
          MAJOR_BUMPS=""
          for file in $CHANGESETS; do
            if [ -f "$file" ]; then
              if sed -n '/^---$/,/^---$/p' "$file" | grep -q ': major'; then
                MAJOR_BUMPS="$MAJOR_BUMPS $file"
              fi
            fi
          done

          if [ -n "$MAJOR_BUMPS" ]; then
            echo "major_bumps=true" >> $GITHUB_OUTPUT
            echo "files_major_bumps=$MAJOR_BUMPS" >> $GITHUB_OUTPUT
            echo "::error::Major version bumps found:$MAJOR_BUMPS"
            HAS_ISSUES=true
          else
            echo "major_bumps=false" >> $GITHUB_OUTPUT
            echo "✅ No major version bumps"
          fi
          # --- End: No major version bumps (pre-1.0) ---

          # --- Summary ---
          if [ "$HAS_ISSUES" = true ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "✅ All changeset validations passed"
          fi

      - name: Comment on PR
        if: steps.validate.outputs.has_issues == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.issue.number;
            const sections = [];

            // Section: Missing PR references
            if (`${{ steps.validate.outputs.missing_refs }}` === 'true') {
              const files = `${{ steps.validate.outputs.files_missing_refs }}`.trim().split(/\s+/);
              const fileList = files.map(f => `- \`${f}\``).join('\n');
              sections.push([
                '### Missing PR Reference',
                '',
                "The following changeset(s) don't contain a PR/issue reference (`#XX`):",
                '',
                fileList,
                '',
                `**How to fix:** Edit the changeset description to include \`#${prNumber}\`:`,
                '',
                '```markdown',
                '---',
                '"@real-router/core": patch',
                '---',
                '',
                `fix: description of the change (#${prNumber})`,
                '```',
              ].join('\n'));
            }

            // Section: Multi-package changesets
            if (`${{ steps.validate.outputs.multi_pkg }}` === 'true') {
              const files = `${{ steps.validate.outputs.files_multi_pkg }}`.trim().split(/\s+/);
              const fileList = files.map(f => `- \`${f}\``).join('\n');
              sections.push([
                '### Multi-Package Changeset',
                '',
                'The following changeset(s) contain multiple packages:',
                '',
                fileList,
                '',
                '**Why this matters:** Multi-package changesets copy identical text to all listed packages\' CHANGELOGs. Create **separate changeset files** for each package instead.',
                '',
                '**How to fix:** Split into one file per package. See [.changeset/README.md](.changeset/README.md) for examples.',
              ].join('\n'));
            }

            // Section: Private packages
            if (`${{ steps.validate.outputs.private_pkgs }}` === 'true') {
              const files = `${{ steps.validate.outputs.files_private_pkgs }}`.trim().split(/\s+/);
              const fileList = files.map(f => `- \`${f}\``).join('\n');
              sections.push([
                '### Private Package in Changeset',
                '',
                'The following changeset(s) reference private packages:',
                '',
                fileList,
                '',
                '**Why this matters:** Private packages (`path-matcher`, `route-tree`, `router-benchmarks`, `search-params`, `type-guards`) are not published to npm and should not have changesets.',
                '',
                '**How to fix:** Remove the private package from the changeset frontmatter. Only include public `@real-router/*` packages.',
              ].join('\n'));
            }

            // Section: Major version bumps (pre-1.0)
            // TODO: Remove this section after 1.0 stable release
            if (`${{ steps.validate.outputs.major_bumps }}` === 'true') {
              const files = `${{ steps.validate.outputs.files_major_bumps }}`.trim().split(/\s+/);
              const fileList = files.map(f => `- \`${f}\``).join('\n');
              sections.push([
                '### Major Version Bump Not Allowed',
                '',
                'The following changeset(s) contain a `major` version bump:',
                '',
                fileList,
                '',
                '**Why this matters:** All packages are in pre-1.0 phase. Use `minor` for breaking changes until the stable 1.0 release.',
                '',
                '**How to fix:** Change `major` to `minor` in the changeset frontmatter.',
              ].join('\n'));
            }
            // End: Major version bumps (pre-1.0)

            const body = [
              '## ❌ Changeset Validation Failed',
              '',
              ...sections,
              '',
              '---',
              '*See [.changeset/README.md](.changeset/README.md) for changeset guidelines.*',
            ].join('\n');

            // Check for existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const marker = 'Changeset Validation Failed';
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }

      - name: Remove outdated comment
        if: steps.validate.outputs.has_changesets == 'true' && steps.validate.outputs.has_issues == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.issue.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const marker = 'Changeset Validation Failed';
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
              });
            }

      - name: Fail if validation issues found
        if: steps.validate.outputs.has_issues == 'true'
        run: |
          echo "Changeset validation failed. See PR comment for details."
          exit 1